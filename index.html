<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Xブックマーク一覧ビューア（タブ10）</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
      max-width: 960px;
      margin-left: auto;
      margin-right: auto;
    }

    /* タブ */
    #tabs {
      max-width: 960px;
      margin-left: auto;
      margin-right: auto;
      margin-bottom: 8px;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .tab-wrapper {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .tab-button {
      padding: 6px 12px;
      font-size: 13px;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
      border-radius: 4px 4px 0 0;
    }
    .tab-button.active {
      background: #fff;
      border-bottom-color: #fff;
      font-weight: bold;
    }
    .tab-edit {
      padding: 4px 6px;
      font-size: 11px;
      border: 1px solid #ccc;
      background: #fafafa;
      cursor: pointer;
      border-radius: 4px;
    }

    #input-area {
      background: #fff;
      padding: 12px;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      margin-bottom: 16px;
      display: flex;
      gap: 8px;
      align-items: center;
      max-width: 960px;
      margin-left: auto;
      margin-right: auto;
      flex-wrap: wrap;
    }
    #tweetUrl {
      flex: 1;
      min-width: 260px;
      padding: 8px;
      font-size: 14px;
    }
    button {
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
    }
    #count {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      max-width: 960px;
      margin-left: auto;
      margin-right: auto;
    }
    #list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* 行レイアウト：左600 / 右320 固定 */
    .tweet-item {
      width: 960px;
      max-width: 100%;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      gap: 14px;
      align-items: flex-start;
      background: #fff;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 0 4px rgba(0,0,0,0.08);
    }
    .tweet-main {
      flex: 0 0 600px;
      width: 600px;
    }
    .memo-area {
      flex: 0 0 320px;
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    iframe {
      width: 100%;
      max-width: 100%;
      border: none;
      overflow: hidden;
    }

    .tweet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 12px;
      color: #666;
    }
    .tweet-url {
      word-break: break-all;
      font-size: 11px;
      color: #999;
      margin-bottom: 4px;
    }
    .btn-delete {
      background: #eee;
      border: none;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
    }
    .btn-delete:hover {
      background: #ffdddd;
    }

    .memo-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .memo-text {
      width: 100%;
      font-size: 12px;
      padding: 6px;
      box-sizing: border-box;
      resize: none;
      overflow-y: auto;
    }
    .mark-buttons {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
    }
    .memo-controls {
      display: flex;
      gap: 4px;
      margin-bottom: 4px;
      justify-content: flex-end;
    }
    .memo-save {
      align-self: flex-end;
      font-size: 12px;
      padding: 4px 10px;
    }
    .memo-saved {
      font-size: 11px;
      color: #008000;
    }
  </style>
</head>
<body>
  <h1>Xブックマーク一覧ビューア（タブ10）</h1>

  <div id="tabs"></div>

  <div id="input-area">
    <input id="tweetUrl" type="text" placeholder="ツイートのURLをペースト">
    <button id="addBtn">追加</button>
    <button id="exportBtn">JSONエクスポート</button>
    <button id="importBtn">JSONインポート</button>
    <input type="file" id="importFile" accept="application/json" style="display:none">
  </div>

  <div id="count"></div>
  <div id="list"></div>

<script>
const TABS_KEY  = "tweetTabs_v1";
const OLD_KEY   = "tweetUrls_simple_v1";
const TAB_COUNT = 10;  // ★ ここを 10 に

let appState = initState();

/* ===== 初期化 ===== */
function initState() {
  const rawTabs = localStorage.getItem(TABS_KEY);
  if (rawTabs) {
    try {
      const parsed = JSON.parse(rawTabs);
      let tabs        = Array.isArray(parsed.tabs) ? parsed.tabs : [];
      let activeIndex = Number.isInteger(parsed.activeIndex) ? parsed.activeIndex : 0;

      tabs = normalizeTabs(tabs);
      while (tabs.length < TAB_COUNT) {
        tabs.push({ name: `タブ${tabs.length+1}`, items: [] });
      }
      if (tabs.length > TAB_COUNT) tabs = tabs.slice(0, TAB_COUNT);
      if (activeIndex < 0 || activeIndex >= tabs.length) activeIndex = 0;

      const s = { tabs, activeIndex };
      saveState(s);
      return s;
    } catch {}
  }

  // 旧フォーマットから移行
  let firstItems = [];
  const old = localStorage.getItem(OLD_KEY);
  if (old) {
    try { firstItems = normalizeItems(JSON.parse(old)); } catch {}
  }

  const tabs = [];
  tabs.push({ name: "タブ1", items: firstItems });
  for (let i = 1; i < TAB_COUNT; i++) {
    tabs.push({ name: `タブ${i+1}`, items: [] });
  }

  const s = { tabs, activeIndex: 0 };
  saveState(s);
  return s;
}

function normalizeItems(arr) {
  if (!Array.isArray(arr)) return [];
  return arr.map(x => {
    if (typeof x === "string") return { url: x, memo: "", height: 600 };
    return {
      url: x.url,
      memo: x.memo || "",
      height: typeof x.height === "number" ? x.height : 600
    };
  });
}

function normalizeTabs(tabs) {
  return tabs.map(t => ({
    name: (t.name || "").trim() || "タブ",
    items: normalizeItems(t.items || [])
  }));
}

function saveState(s) {
  localStorage.setItem(TABS_KEY, JSON.stringify(s));
}

function getCurrentTab()   { return appState.tabs[appState.activeIndex]; }
function getCurrentItems() { return getCurrentTab().items; }

function setCurrentItems(items) {
  appState.tabs[appState.activeIndex].items = items;
  saveState(appState);
}

/* ===== タブ描画 ===== */
function renderTabs() {
  const tabsDiv = document.getElementById("tabs");
  tabsDiv.innerHTML = "";
  appState.tabs.forEach((tab, i) => {
    const wrap = document.createElement("div");
    wrap.className = "tab-wrapper";

    const btn = document.createElement("button");
    btn.className = "tab-button" + (i === appState.activeIndex ? " active" : "");
    btn.textContent = tab.name;
    btn.onclick = () => {
      appState.activeIndex = i;
      saveState(appState);
      renderTabs();
      renderList();
    };

    const edit = document.createElement("button");
    edit.className = "tab-edit";
    edit.textContent = "✎";
    edit.onclick = ev => {
      ev.stopPropagation();
      const name = prompt("タブ名を入力", tab.name);
      if (!name) return;
      appState.tabs[i].name = name;
      saveState(appState);
      renderTabs();
      updateCount();
    };

    wrap.appendChild(btn);
    wrap.appendChild(edit);
    tabsDiv.appendChild(wrap);
  });
}

function updateCount() {
  const items = getCurrentItems();
  const tabName = getCurrentTab().name;
  document.getElementById("count").textContent =
    `${tabName} の保存件数: ${items.length} 件`;
}

/* ===== ツイート埋め込み ===== */
function extractTweetId(url) {
  if (!url) return null;
  if (!url.startsWith("http")) url = "https://" + url;
  const m = url.match(/status\/(\d+)/);
  return m ? m[1] : null;
}

function createTweetItem(item, index) {
  const root = document.createElement("div");
  root.className = "tweet-item";

  /* 左：ツイート */
  const main = document.createElement("div");
  main.className = "tweet-main";

  const head = document.createElement("div");
  head.className = "tweet-header";
  head.innerHTML = `<span>#${index + 1}</span>`;

  const del = document.createElement("button");
  del.className = "btn-delete";
  del.textContent = "削除";
  del.onclick = () => {
    const arr = getCurrentItems();
    arr.splice(index, 1);
    setCurrentItems(arr);
    renderList();
  };
  head.appendChild(del);

  const urlText = document.createElement("div");
  urlText.className = "tweet-url";
  urlText.textContent = item.url;

  const embed = document.createElement("div");
  const tid = extractTweetId(item.url);
  let iframe = null;
  if (tid) {
    iframe = document.createElement("iframe");
    iframe.src = "https://platform.twitter.com/embed/Tweet.html?id=" + tid;
    iframe.scrolling = "no";
    iframe.loading = "lazy";
    embed.appendChild(iframe);
  } else {
    embed.textContent = "ツイートIDエラー";
  }

  main.appendChild(head);
  main.appendChild(urlText);
  main.appendChild(embed);

  /* 右：メモ */
  const memoBox = document.createElement("div");
  memoBox.className = "memo-area";

  const label = document.createElement("div");
  label.className = "memo-label-row";
  label.textContent = "メモ";
  memoBox.appendChild(label);

  /* 並び替え＆高さ調整ボタン（↑ ↓ +20 -20） */
  const ctr = document.createElement("div");
  ctr.className = "memo-controls";

  const upBtn   = document.createElement("button");
  const downBtn = document.createElement("button");
  const plus    = document.createElement("button");
  const minus   = document.createElement("button");

  upBtn.textContent   = "↑";
  downBtn.textContent = "↓";
  plus.textContent    = "+20";
  minus.textContent   = "-20";

  ctr.appendChild(upBtn);
  ctr.appendChild(downBtn);
  ctr.appendChild(plus);
  ctr.appendChild(minus);
  memoBox.appendChild(ctr);

  const ta = document.createElement("textarea");
  ta.className = "memo-text";
  ta.value = item.memo;
  memoBox.appendChild(ta);

  const marks = document.createElement("div");
  marks.className = "mark-buttons";
  ["★","●","▲","■"].forEach(m => {
    const b = document.createElement("button");
    b.textContent = m;
    b.onclick = () => { ta.value += m; };
    marks.appendChild(b);
  });
  memoBox.appendChild(marks);

  const bottom = document.createElement("div");
  bottom.style.display = "flex";
  bottom.style.justifyContent = "space-between";
  bottom.style.alignItems   = "center";

  const saved = document.createElement("span");
  saved.className = "memo-saved";

  const saveBtn = document.createElement("button");
  saveBtn.className = "memo-save";
  saveBtn.textContent = "保存";

  bottom.appendChild(saved);
  bottom.appendChild(saveBtn);
  memoBox.appendChild(bottom);

  root.appendChild(main);
  root.appendChild(memoBox);

  /* 高さ制御 */
  let h = item.height || 600;
  function apply(save) {
    if (iframe) iframe.style.height = h + "px";
    ta.style.height = Math.max(60, Math.floor(h * 0.8)) + "px";
    if (save) {
      const arr = getCurrentItems();
      arr[index].height = h;
      setCurrentItems(arr);
    }
  }
  plus.onclick  = () => { h += 20; apply(true); };
  minus.onclick = () => { h -= 20; apply(true); };

  /* 並び替え（上下入れ替え） */
  upBtn.onclick = () => {
    const arr = getCurrentItems();
    if (index <= 0) return;
    const tmp = arr[index - 1];
    arr[index - 1] = arr[index];
    arr[index]     = tmp;
    setCurrentItems(arr);
    renderList();
  };
  downBtn.onclick = () => {
    const arr = getCurrentItems();
    if (index >= arr.length - 1) return;
    const tmp = arr[index + 1];
    arr[index + 1] = arr[index];
    arr[index]     = tmp;
    setCurrentItems(arr);
    renderList();
  };

  saveBtn.onclick = () => {
    const arr = getCurrentItems();
    arr[index].memo = ta.value;
    setCurrentItems(arr);
    saved.textContent = "保存しました";
    setTimeout(() => { saved.textContent = ""; }, 1200);
  };

  apply(false);
  return root;
}

/* ===== リスト描画 ===== */
function renderList() {
  const arr  = getCurrentItems();
  const list = document.getElementById("list");
  list.innerHTML = "";
  arr.forEach((it, i) => list.appendChild(createTweetItem(it, i)));
  updateCount();
}

/* ===== 追加＆入出力 ===== */
function addItem() {
  const inp = document.getElementById("tweetUrl");
  let url = inp.value.trim();
  if (!url) return;
  if (!url.startsWith("http")) url = "https://" + url;

  const arr = getCurrentItems();
  if (arr.some(x => x.url === url)) {
    alert("すでに登録済みです");
    return;
  }
  arr.unshift({ url, memo: "", height: 600 });
  setCurrentItems(arr);
  inp.value = "";
  renderList();
}

function exportJson() {
  const arr  = getCurrentItems();
  const text = JSON.stringify(arr, null, 2);
  const blob = new Blob([text], { type: "application/json" });

  const now = new Date();
  const pad = n => String(n).padStart(2, "0");
  const name = getCurrentTab().name.replace(/[\\\/:*?"<>|]/g, "_");
  const fname =
    `x_tab_${name}_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.json`;

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = fname;
  a.click();
  URL.revokeObjectURL(a.href);
}

function handleImportFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  const rd = new FileReader();
  rd.onload = () => {
    try {
      const arr = JSON.parse(rd.result);
      if (!Array.isArray(arr)) {
        alert("配列形式ではありません");
        return;
      }
      setCurrentItems(normalizeItems(arr));
      renderList();
    } catch {
      alert("JSON解析エラー");
    }
  };
  rd.readAsText(file);
  e.target.value = "";
}

/* ===== タブ切り替えショートカット ===== */
/* 1〜9 → タブ1〜9, 0 → タブ10 */
function handleTabShortcut(e) {
  const tag = (e.target.tagName || "").toUpperCase();
  if (tag === "INPUT" || tag === "TEXTAREA") return; // 入力中は無効

  let idx = null;
  if (e.key >= "1" && e.key <= "9") {
    idx = parseInt(e.key, 10) - 1;
  } else if (e.key === "0") {
    idx = 9; // タブ10
  }
  if (idx === null) return;
  if (idx < 0 || idx >= TAB_COUNT) return;

  appState.activeIndex = idx;
  saveState(appState);
  renderTabs();
  renderList();
}

window.onload = () => {
  document.getElementById("addBtn").onclick = addItem;
  document.getElementById("tweetUrl").addEventListener("keydown", e => {
    if (e.key === "Enter") addItem();
  });
  document.getElementById("exportBtn").onclick =
    () => exportJson();
  document.getElementById("importBtn").onclick =
    () => document.getElementById("importFile").click();
  document.getElementById("importFile").addEventListener("change", handleImportFile);

  document.addEventListener("keydown", handleTabShortcut);

  renderTabs();
  renderList();
};
</script>
</body>
</html>
